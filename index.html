<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>NSUK URP E-Attendance System</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- AutoTable plugin for jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f1b3d",
                        "primary-hover": "#0a1430",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "success": "#10b981",
                        "warning": "#f59e0b",
                        "danger": "#ef4444",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.75rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px"},
                    boxShadow: {
                        "soft": "0 2px 8px rgba(15, 23, 42, 0.08)",
                        "glow": "0 0 15px rgba(15, 27, 61, 0.3)"
                    }
                },
            },
        }
    </script>
    
    <style>
        body { min-height: 100vh; font-family: 'Lexend', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .form-input:focus { box-shadow: 0 0 0 3px rgba(15, 27, 61, 0.1); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0f1b3d; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .stat-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-gradient-5 { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); }
        .face-image-container { position: relative; width: 256px; height: 256px; margin: 0 auto; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); border: 3px solid #10b981; }
        .face-verification-badge { position: absolute; top: 12px; right: 12px; background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 10; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
        #video { transform: scaleX(-1); border-radius: 1rem; background: #000; }
        .view-container { display: none; }
        .view-container.active { display: block; animation: fadeIn 0.3s ease-out; }
        @media print { .no-print { display: none !important; } body { background: #fff !important; } }
        .sync-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; }
        .sync-indicator.syncing { color: #f59e0b; }
        .sync-indicator.synced { color: #10b981; }
        .sync-indicator.error { color: #ef4444; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display" data-view="home">
    <!-- Navigation Bar -->
    <nav class="bg-surface-light dark:bg-surface-dark shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <!-- Updated NSUK Logo -->
                    <img src="static/NSUK-logo.jpg" alt="NSUK Logo" class="h-10 w-10 rounded-lg object-cover">
                    <div>
                        <h1 class="text-lg font-bold text-primary dark:text-white">NSUK URP</h1>
                        <p class="text-xs text-slate-600 dark:text-slate-400">E-Attendance System</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="authLinks" class="flex items-center space-x-3">
                        <a href="#" onclick="showView('login')" class="auth-link text-primary hover:text-primary-hover font-semibold">Login</a>
                        <a href="#" onclick="showView('signup')" class="auth-link bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">Sign Up</a>
                    </div>
                    
                    <div id="userInfo" class="hidden flex items-center space-x-3">
                        <span id="userRole" class="text-sm text-slate-700 dark:text-slate-300"></span>
                        <span id="deviceIndicator" class="hidden md:inline-flex items-center text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 px-2 py-1 rounded-full">
                            <span class="material-symbols-outlined text-xs mr-1">devices</span>
                            <span id="deviceCount">1</span> device(s)
                        </span>
                        <a href="#" onclick="logout()" class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">Logout</a>
                    </div>
                    
                    <button onclick="toggleTheme()" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700">
                        <span id="themeIcon" class="material-symbols-outlined text-slate-700 dark:text-slate-300">dark_mode</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="flashMessages" class="container mx-auto px-4 py-4"></div>

    <main id="mainContent" class="container mx-auto px-4 py-8">
        
        <!-- SPLASH SCREEN -->
        <div id="splashView" class="view-container active">
            <div class="relative z-10 max-w-md w-full bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center mx-auto">
                <!-- Updated NSUK Logo -->
                <img src="static/NSUK-logo.jpg" class="mx-auto h-24 w-24 rounded-xl shadow mb-6 object-cover" alt="NSUK Logo">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">NSUK URP</h1>
                <p class="text-slate-600 dark:text-slate-400 mt-2 mb-8">E-Attendance System</p>
                
                <div class="flex flex-col gap-4">
                    <button onclick="showView('home')" class="bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-semibold transition">Enter System</button>
                    <button onclick="showView('login')" class="border border-primary text-primary py-3 rounded-xl font-semibold hover:bg-primary/10 transition">Login</button>
                    <button onclick="showView('signup')" class="text-sm text-slate-500 hover:text-primary transition">Create Account</button>
                </div>
                
                <p class="mt-8 text-xs text-slate-500">Version 2.1.0 â€¢ Cross-Device Sync Enabled</p>
            </div>
        </div>

        <!-- HOME PAGE -->
        <div id="homeView" class="view-container">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <div class="flex justify-center mb-6">
                        <!-- Updated NSUK Logo -->
                        <img src="static/NSUK-logo.jpg" alt="NSUK Logo" class="h-24 w-24 rounded-2xl shadow-lg object-cover">
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white mb-4">NSUK URP E-Attendance System</h1>
                    <p class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">Streamline attendance tracking for Urban and Regional Planning Department with cloud synchronization</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft fade-in" style="animation-delay: 0.1s">
                        <div class="flex items-center justify-center w-12 h-12 bg-primary/10 rounded-xl mb-4">
                            <span class="material-symbols-outlined text-primary text-2xl">school</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">For Students</h3>
                        <p class="text-slate-600 dark:text-slate-400">Submit attendance with location and face verification from any device</p>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft fade-in" style="animation-delay: 0.2s">
                        <div class="flex items-center justify-center w-12 h-12 bg-primary/10 rounded-xl mb-4">
                            <span class="material-symbols-outlined text-primary text-2xl">co_present</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">For Lecturers</h3>
                        <p class="text-slate-600 dark:text-slate-400">Manage classes, track attendance in real-time from any device</p>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft fade-in" style="animation-delay: 0.3s">
                        <div class="flex items-center justify-center w-12 h-12 bg-primary/10 rounded-xl mb-4">
                            <span class="material-symbols-outlined text-primary text-2xl">admin_panel_settings</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">For Administrators</h3>
                        <p class="text-slate-600 dark:text-slate-400">System configuration, user management, and comprehensive monitoring</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-primary to-primary-hover rounded-2xl p-8 text-center text-white fade-in" style="animation-delay: 0.4s">
                    <h2 class="text-2xl font-bold mb-4">Ready to Get Started?</h2>
                    <p class="mb-6 opacity-90">Join thousands of students and lecturers using our modern attendance system</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="showView('signup')" class="bg-white text-primary hover:bg-slate-100 px-6 py-3 rounded-xl font-semibold transition-colors">Create Account</button>
                        <button onclick="showView('login')" class="bg-transparent border-2 border-white hover:bg-white/10 px-6 py-3 rounded-xl font-semibold transition-colors">Sign In</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOGIN PAGE - Enhanced with Cloud Sync -->
        <div id="loginView" class="view-container">
            <div class="max-w-md mx-auto">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <span class="material-symbols-outlined text-primary text-5xl mb-2">lock</span>
                        <h2 class="text-2xl font-bold">Sign In</h2>
                        <p class="text-slate-500 text-sm mt-1">Enter your credentials to access the system</p>
                    </div>

                    <form id="loginForm" class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Username / Matric No.</label>
                            <input type="text" id="loginUsername" required class="w-full rounded-xl border-slate-300 focus:border-primary focus:ring-primary" placeholder="Enter username or matric number">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-1">Password</label>
                            <input type="password" id="loginPassword" required class="w-full rounded-xl border-slate-300 focus:border-primary focus:ring-primary" placeholder="Enter your password">
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" id="remember" class="rounded border-slate-300 text-primary focus:ring-primary">
                                <label for="remember" class="ml-2 text-sm text-slate-600">Remember me</label>
                            </div>
                            <button type="button" onclick="showView('reset')" class="text-sm text-primary hover:underline">Forgot password?</button>
                        </div>

                        <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-semibold transition">
                            <span class="material-symbols-outlined align-middle mr-1">login</span>Login
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-slate-500">
                        Don't have an account? <button onclick="showView('signup')" class="text-primary font-semibold hover:underline ml-1">Sign up</button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-xs text-slate-400 flex items-center justify-center">
                            <span class="material-symbols-outlined text-sm mr-1">cloud_sync</span>
                            Cloud-synchronized across all devices
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNUP PAGE - Enhanced with Cloud Sync -->
        <div id="signupView" class="view-container">
            <div class="max-w-md mx-auto">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8">
                    <div class="text-center mb-8">
                        <div class="flex justify-center mb-4">
                            <!-- Updated NSUK Logo -->
                            <img src="static/NSUK-logo.jpg" alt="NSUK Logo" class="h-16 w-16 rounded-xl object-cover">
                        </div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Create Account</h2>
                        <p class="text-slate-600 dark:text-slate-400 mt-2">Join NSUK URP E-Attendance System</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-900 dark:text-white mb-3">Select Account Type</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" onclick="selectRole('student')" id="roleStudent" class="role-btn p-4 border-2 border-slate-200 dark:border-slate-700 rounded-xl text-center transition-all hover:border-primary hover:bg-primary/5">
                                <span class="material-symbols-outlined block text-2xl mb-2">school</span>
                                <span class="font-semibold">Student</span>
                            </button>
                            <button type="button" onclick="selectRole('lecturer')" id="roleLecturer" class="role-btn p-4 border-2 border-slate-200 dark:border-slate-700 rounded-xl text-center transition-all hover:border-primary hover:bg-primary/5">
                                <span class="material-symbols-outlined block text-2xl mb-2">co_present</span>
                                <span class="font-semibold">Lecturer</span>
                            </button>
                            <button type="button" onclick="selectRole('admin')" id="roleAdmin" class="role-btn p-4 border-2 border-slate-200 dark:border-slate-700 rounded-xl text-center transition-all hover:border-primary hover:bg-primary/5">
                                <span class="material-symbols-outlined block text-2xl mb-2">admin_panel_settings</span>
                                <span class="font-semibold">Admin</span>
                            </button>
                        </div>
                    </div>

                    <form id="signupForm" class="space-y-6">
                        <input type="hidden" id="selectedRole" value="student">
                        
                        <div>
                            <label for="fullName" class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Full Name *</label>
                            <input type="text" id="fullName" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-xl form-input" placeholder="Enter your full name">
                        </div>

                        <div id="matricField">
                            <label for="matricNumber" class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Matric Number *</label>
                            <input type="text" id="matricNumber" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-xl form-input" placeholder="e.g., URP/2023/001">
                        </div>

                        <div>
                            <label for="signupUsername" class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Username *</label>
                            <input type="text" id="signupUsername" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-xl form-input" placeholder="Choose a username">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">This will be used for login</p>
                        </div>

                        <div>
                            <label for="signupPassword" class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Password *</label>
                            <div class="relative">
                                <input type="password" id="signupPassword" required minlength="8" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-xl form-input pr-12" placeholder="Create a password" oninput="checkPasswordStrength(this.value)">
                                <button type="button" onclick="togglePassword('signupPassword', 'passwordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                    <span id="passwordToggle" class="material-symbols-outlined">visibility_off</span>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div id="passwordStrength" class="text-xs"></div>
                                <div class="grid grid-cols-4 gap-1 mt-1">
                                    <div id="strength1" class="h-1 rounded bg-slate-200 dark:bg-slate-700"></div>
                                    <div id="strength2" class="h-1 rounded bg-slate-200 dark:bg-slate-700"></div>
                                    <div id="strength3" class="h-1 rounded bg-slate-200 dark:bg-slate-700"></div>
                                    <div id="strength4" class="h-1 rounded bg-slate-200 dark:bg-slate-700"></div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="confirmPassword" class="block text-sm font-semibold text-slate-900 dark:text-white mb-2">Confirm Password *</label>
                            <div class="relative">
                                <input type="password" id="confirmPassword" required minlength="8" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded-xl form-input pr-12" placeholder="Confirm your password" oninput="checkPasswordMatch()">
                                <button type="button" onclick="togglePassword('confirmPassword', 'confirmPasswordToggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                                    <span id="confirmPasswordToggle" class="material-symbols-outlined">visibility_off</span>
                                </button>
                            </div>
                            <div id="passwordMatch" class="text-xs mt-1"></div>
                        </div>

                        <div class="flex items-start">
                            <input type="checkbox" id="terms" required class="mt-1 rounded border-slate-300 text-primary focus:ring-primary">
                            <label for="terms" class="ml-2 text-sm text-slate-700 dark:text-slate-300">
                                I agree to the <a href="#" class="text-primary hover:text-primary-hover font-semibold">Terms of Service</a> and <a href="#" class="text-primary hover:text-primary-hover font-semibold">Privacy Policy</a>
                            </label>
                        </div>

                        <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-semibold transition-colors">Create Account</button>

                        <div class="text-center pt-4 border-t border-slate-200 dark:border-slate-700">
                            <p class="text-slate-600 dark:text-slate-400">Already have an account? <button onclick="showView('login')" class="text-primary hover:text-primary-hover font-semibold">Sign in here</button></p>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-xs text-slate-400 flex items-center justify-center">
                                <span class="material-symbols-outlined text-sm mr-1">cloud_upload</span>
                                Your account will be synced to the cloud for access on all devices
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PASSWORD RESET PAGE -->
        <div id="resetView" class="view-container">
            <div class="max-w-md mx-auto">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8">
                    <div class="text-center mb-6">
                        <span class="material-symbols-outlined text-primary text-5xl mb-2">lock_reset</span>
                        <h2 class="text-2xl font-bold">Reset Password</h2>
                        <p class="text-slate-500 text-sm mt-1">Enter your email to receive reset instructions</p>
                    </div>

                    <form id="resetForm" class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold mb-1">Username or Email</label>
                            <input type="text" id="resetUsername" required class="w-full rounded-xl border-slate-300 focus:border-primary focus:ring-primary" placeholder="Enter your username or email">
                        </div>

                        <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-semibold transition">
                            <span class="material-symbols-outlined align-middle mr-1">send</span>Send Reset Link
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm text-slate-500">
                        Remember your password? <button onclick="showView('login')" class="text-primary font-semibold hover:underline ml-1">Sign in</button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-xs text-slate-400">A reset link will be sent to your registered email</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STUDENT DASHBOARD -->
        <div id="studentDashboardView" class="view-container">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 mb-8 border-l-4 border-primary">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white" id="studentName">Loading...</h1>
                        <p class="text-slate-600 dark:text-slate-400 mt-2">Submit your attendance with location and face verification</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary/10 text-primary dark:text-blue-400 px-4 py-2 rounded-lg"><span class="font-semibold">Student</span></div>
                        <span class="material-symbols-outlined text-4xl text-primary dark:text-blue-400">school</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <!-- Location Capture -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6">
                        <div class="flex items-center mb-6">
                            <div class="flex items-center justify-center w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl mr-4">
                                <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">location_on</span>
                            </div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white">1. Capture Location</h2>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl mb-4">
                            <p class="text-blue-800 dark:text-blue-300 mb-4">
                                <span class="material-symbols-outlined align-middle mr-2">info</span>
                                Click the button below to capture your current location for verification
                            </p>
                            
                            <button id="captureLocation" class="bg-primary hover:bg-primary-hover text-white py-3 px-6 rounded-xl font-semibold transition-colors flex items-center">
                                <span class="material-symbols-outlined mr-2">location_on</span>Capture Location
                            </button>
                            
                            <div class="mt-6 space-y-3">
                                <div id="locationStatus" class="text-sm text-slate-600 dark:text-slate-400">
                                    <span class="material-symbols-outlined align-middle text-yellow-600">pending</span>Location not captured yet
                                </div>
                                <div id="coordinates" class="hidden mt-2 space-y-2">
                                    <div class="flex items-center space-x-3">
                                        <span class="material-symbols-outlined text-green-600">check_circle</span>
                                        <div>
                                            <p class="text-sm text-slate-700 dark:text-slate-300">Latitude: <span id="latitude" class="font-mono font-bold">-</span></p>
                                            <p class="text-sm text-slate-700 dark:text-slate-300">Longitude: <span id="longitude" class="font-mono font-bold">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Face Capture -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6">
                        <div class="flex items-center mb-6">
                            <div class="flex items-center justify-center w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl mr-4">
                                <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">face</span>
                            </div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white">2. Capture Face</h2>
                        </div>
                        
                        <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-xl">
                            <div class="mb-6">
                                <div id="cameraContainer" class="hidden">
                                    <video id="video" width="100%" height="auto" autoplay playsinline class="rounded-xl"></video>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-2 text-center">Ensure your face is clearly visible in the frame</p>
                                </div>
                                <div id="noCamera" class="text-center py-8">
                                    <span class="material-symbols-outlined text-4xl text-slate-400 mb-4">videocam_off</span>
                                    <p class="text-slate-600 dark:text-slate-400">Camera will appear here when started</p>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-4">
                                <button id="startCamera" class="bg-primary hover:bg-primary-hover text-white py-3 px-6 rounded-xl font-semibold transition-colors flex items-center">
                                    <span class="material-symbols-outlined mr-2">videocam</span>Start Camera
                                </button>
                                <button id="captureFace" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-xl font-semibold transition-colors flex items-center" disabled>
                                    <span class="material-symbols-outlined mr-2">camera</span>Capture Face
                                </button>
                                <button id="retakePhoto" class="bg-slate-600 hover:bg-slate-700 text-white py-3 px-6 rounded-xl font-semibold transition-colors flex items-center hidden">
                                    <span class="material-symbols-outlined mr-2">refresh</span>Retake Photo
                                </button>
                            </div>
                            
                            <div id="facePreview" class="mt-6 hidden">
                                <h3 class="font-semibold text-slate-900 dark:text-white mb-3">Captured Image</h3>
                                <div class="flex flex-col md:flex-row items-center gap-6">
                                    <img id="capturedImage" src="" alt="Captured Face" class="rounded-xl max-w-xs border-4 border-green-200 dark:border-green-900">
                                    <div class="text-green-600 dark:text-green-400 flex items-center">
                                        <span class="material-symbols-outlined text-4xl mr-2">check_circle</span>
                                        <div>
                                            <p class="font-semibold">Face captured successfully!</p>
                                            <p class="text-sm text-slate-600 dark:text-slate-400">Ready for submission</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Form -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6">
                        <div class="flex items-center mb-6">
                            <div class="flex items-center justify-center w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-xl mr-4">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400">fact_check</span>
                            </div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white">3. Submit Attendance</h2>
                        </div>
                        
                        <form id="attendanceForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Full Name</label>
                                    <input type="text" id="studentFullNameInput" readonly class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Matric Number</label>
                                    <input type="text" id="studentMatricInput" readonly class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-900 font-mono text-slate-700 dark:text-slate-300">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Course Code *</label>
                                <select id="courseCode" required class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-900 focus:ring-2 focus:ring-primary focus:border-transparent transition-colors">
                                    <option value="">Select Course</option>
                                    <option value="URP213">URP 213 - Introduction to Land Surveying</option>
                                    <option value="URP313">URP 313 - Regional Development Planning</option>
                                    <option value="URP431">URP 431 - Planning Studio VII (Master Plan)</option>
                                    <option value="URP435">URP 435 - Public Utilities and Services</option>
                                    <option value="URP419">URP 419 - Pollution Control and Management</option>
                                    <option value="URP302">URP 302 - Housing and Community Development</option>
                                </select>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Note: The selected course code will be recorded in the attendance system</p>
                            </div>
                            
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-900 rounded-xl p-4">
                                <div class="flex items-start">
                                    <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 mr-3 mt-1">warning</span>
                                    <div>
                                        <p class="font-semibold text-slate-900 dark:text-white mb-1">Requirements before submission:</p>
                                        <ul class="text-sm text-slate-600 dark:text-slate-400 space-y-1">
                                            <li class="flex items-center">
                                                <span id="locationCheck" class="material-symbols-outlined text-red-500 mr-2 text-sm">radio_button_unchecked</span>Location captured
                                            </li>
                                            <li class="flex items-center">
                                                <span id="faceCheck" class="material-symbols-outlined text-red-500 mr-2 text-sm">radio_button_unchecked</span>Face image captured
                                            </li>
                                            <li class="flex items-center">
                                                <span id="courseCheck" class="material-symbols-outlined text-red-500 mr-2 text-sm">radio_button_unchecked</span>Course selected
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" id="submitBtn" class="w-full bg-primary hover:bg-primary-hover text-white py-4 rounded-xl font-semibold transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span class="material-symbols-outlined mr-2">check_circle</span>Submit Attendance
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Student Info -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Student Information</h3>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-slate-400">person</span>
                                <div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Full Name</p>
                                    <p id="studentFullName" class="font-medium">-</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-slate-400">badge</span>
                                <div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Matric Number</p>
                                    <p id="studentMatric" class="font-mono font-medium">-</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-slate-400">devices</span>
                                <div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Active Devices</p>
                                    <p id="studentDeviceCount" class="font-medium text-green-600 dark:text-green-400">1 device</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="material-symbols-outlined text-slate-400">cloud_sync</span>
                                <div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Sync Status</p>
                                    <p id="studentSyncStatus" class="font-medium text-green-600 dark:text-green-400">Cloud-synced</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Attendance -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Recent Attendance</h3>
                        <div id="recentAttendance" class="space-y-4 max-h-[400px] overflow-y-auto">
                            <div class="text-center py-8">
                                <span class="material-symbols-outlined text-4xl text-slate-400 mb-4">history</span>
                                <p class="text-slate-500 dark:text-slate-400">No attendance records yet</p>
                                <p class="text-sm text-slate-500 dark:text-slate-500 mt-2">Submit your first attendance above</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LECTURER DASHBOARD - Enhanced for cross-device visibility -->
        <div id="lecturerDashboardView" class="view-container">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 mb-8 border-l-4 border-primary">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white" id="lecturerName">Loading...</h1>
                        <p class="text-slate-600 dark:text-slate-400 mt-2">Manage classes and track student attendance in real-time</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary/10 text-primary dark:text-blue-400 px-4 py-2 rounded-lg"><span class="font-semibold">Lecturer</span></div>
                        <span class="material-symbols-outlined text-4xl text-primary dark:text-blue-400">co_present</span>
                    </div>
                </div>
            </div>

            <!-- Manual Sync Button -->
            <div class="mb-6 flex justify-end">
                <button onclick="forceCloudSync()" class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-xl font-semibold transition-colors flex items-center">
                    <span class="material-symbols-outlined mr-2">cloud_sync</span>
                    Sync Now
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-gradient-1 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Total Students</p>
                            <p class="text-3xl font-bold" id="totalStudents">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">groups</span>
                    </div>
                </div>
                
                <div class="stat-gradient-2 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Present Today</p>
                            <p class="text-3xl font-bold" id="presentToday">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">check_circle</span>
                    </div>
                </div>
                
                <div class="stat-gradient-3 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Active Sessions</p>
                            <p class="text-3xl font-bold" id="activeSessions">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">event_available</span>
                    </div>
                </div>
            </div>

            <!-- Submitted Attendance Table - Enhanced with cross-device sync -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Submitted Attendance</h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-slate-400">filter_list</span>
                            <select id="courseFilter" onchange="filterAttendanceByCourse()" class="bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-1 text-sm">
                                <option value="all">All Courses</option>
                                <option value="URP213">URP 213</option>
                                <option value="URP313">URP 313</option>
                                <option value="URP431">URP 431</option>
                                <option value="URP435">URP 435</option>
                                <option value="URP419">URP 419</option>
                                <option value="URP302">URP 302</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="autoRefresh" checked class="mr-2 rounded border-slate-300 text-primary focus:ring-primary">
                                <label for="autoRefresh" class="text-sm text-slate-600 dark:text-slate-400">Auto-refresh</label>
                            </div>
                            <button onclick="refreshAttendanceTable()" class="bg-primary/10 text-primary dark:text-blue-400 hover:bg-primary/20 px-3 py-1 rounded-lg text-sm font-medium transition-colors flex items-center">
                                <span class="material-symbols-outlined text-sm mr-1">refresh</span>Refresh Now
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-900">
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Student Name</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Matric No.</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Course</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Date</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Time</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Location</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-slate-700 dark:text-slate-300">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submittedAttendance">
                            <tr id="noSubmittedRecords">
                                <td colspan="7" class="py-8 px-4 text-center text-slate-500 dark:text-slate-400">
                                    <span class="material-symbols-outlined text-4xl mb-3 block mx-auto">assignment</span>
                                    No attendance records found
                                    <p class="text-sm mt-2">When students submit attendance, they will appear here</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-slate-500 dark:text-slate-400 flex justify-between items-center">
                    <div id="attendanceCount">Showing 0 records</div>
                    <div class="flex items-center space-x-2">
                        <div class="text-xs text-slate-500 dark:text-slate-500">
                            <span class="material-symbols-outlined text-xs align-middle mr-1">cloud_sync</span>
                            Last cloud sync: <span id="lastSyncTime">Just now</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousPage()" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" disabled id="prevBtn">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button onclick="nextPage()" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800" disabled id="nextBtn">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="startSession()" class="bg-primary hover:bg-primary-hover text-white py-3 rounded-xl font-semibold transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined mr-2">add_circle</span>Start New Session
                </button>
                <button onclick="generateReport()" class="bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-semibold transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined mr-2">summarize</span>Generate Report
                </button>
                <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold transition-colors flex items-center justify-center">
                    <span class="material-symbols-outlined mr-2">download</span>Export CSV
                </button>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="adminDashboardView" class="view-container">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 mb-8 border-l-4 border-primary">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white" id="adminName">Loading...</h1>
                        <p class="text-slate-600 dark:text-slate-400 mt-2">System administration and user management</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary/10 text-primary dark:text-blue-400 px-4 py-2 rounded-lg"><span class="font-semibold">Administrator</span></div>
                        <span class="material-symbols-outlined text-4xl text-primary dark:text-blue-400">admin_panel_settings</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="stat-gradient-1 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Total Admins</p>
                            <p class="text-3xl font-bold" id="totalAdmins">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">admin_panel_settings</span>
                    </div>
                </div>
                
                <div class="stat-gradient-2 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Total Users</p>
                            <p class="text-3xl font-bold" id="totalUsers">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">group</span>
                    </div>
                </div>
                
                <div class="stat-gradient-3 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Active Sessions</p>
                            <p class="text-3xl font-bold" id="activeSessionsAdmin">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">event_available</span>
                    </div>
                </div>
                
                <div class="stat-gradient-4 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Attendance Today</p>
                            <p class="text-3xl font-bold" id="attendanceToday">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">trending_up</span>
                    </div>
                </div>
                
                <div class="stat-gradient-5 text-white rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Pending Approvals</p>
                            <p class="text-3xl font-bold" id="pendingApprovals">0</p>
                        </div>
                        <span class="material-symbols-outlined text-4xl opacity-80">person_add</span>
                    </div>
                </div>
            </div>

            <!-- Lecturer Approvals Section -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 mb-8">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Lecturer Signup Approvals</h2>
                <div class="space-y-4 max-h-[500px] overflow-y-auto" id="lecturerApprovalsList">
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-500 mb-3">check_circle</span>
                        <p class="text-slate-500 dark:text-slate-400">No pending lecturer approvals</p>
                        <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">All lecturers are approved</p>
                    </div>
                </div>
            </div>

            <!-- System Management -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="viewAllUsers()" class="bg-blue-100 dark:bg-blue-900/20 hover:bg-blue-200 dark:hover:bg-blue-900/40 text-blue-800 dark:text-blue-300 p-6 rounded-xl transition-colors flex flex-col items-center justify-center">
                    <span class="material-symbols-outlined text-4xl mb-3">group</span>
                    <span class="font-semibold">View All Users</span>
                </button>
                <button onclick="viewAllAttendance()" class="bg-green-100 dark:bg-green-900/20 hover:bg-green-200 dark:hover:bg-green-900/40 text-green-800 dark:text-green-300 p-6 rounded-xl transition-colors flex flex-col items-center justify-center">
                    <span class="material-symbols-outlined text-4xl mb-3">assignment</span>
                    <span class="font-semibold">View All Attendance</span>
                </button>
                <button onclick="manageCourses()" class="bg-purple-100 dark:bg-purple-900/20 hover:bg-purple-200 dark:hover:bg-purple-900/40 text-purple-800 dark:text-purple-300 p-6 rounded-xl transition-colors flex flex-col items-center justify-center">
                    <span class="material-symbols-outlined text-4xl mb-3">menu_book</span>
                    <span class="font-semibold">Manage Courses</span>
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-surface-light dark:bg-surface-dark border-t border-slate-200 dark:border-slate-800 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-3">
                        <!-- Updated NSUK Logo -->
                        <img src="static/NSUK-logo.jpg" alt="NSUK Logo" class="h-8 w-8 rounded object-cover">
                        <div>
                            <p class="font-bold text-slate-900 dark:text-white">NSUK URP</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">E-Attendance System</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <p class="text-sm text-slate-600 dark:text-slate-400">
                        Department of Urban and Regional Planning<br>
                        Nasarawa State University, Keffi
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-500 mt-2">Developed by A. Suleiman â€¢ Â© <span id="currentYear"></span> â€¢ Cross-Device Sync v2.1</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Remote storage configuration
        const REMOTE_STORAGE_URL = 'https://api.jsonbin.io/v3/b/67ccb2c0acd3cb34a8b8c0bf'; // Your JSONBin.io bin ID
        const API_KEY = '$2a$10$L9fOAkuC.CUIN3cx7wj38uY0/p2d9Z21ymw.DJG4d5YlX0JyNqWaW'; // Your JSONBin.io API key
        
        // Current user data
        let currentUser = null;
        let currentLocation = null;
        let faceImage = null;
        let videoStream = null;
        let isLocationCaptured = false;
        let isFaceCaptured = false;
        let isCourseSelected = false;
        
        // Pagination variables for lecturer dashboard
        let currentPage = 1;
        const recordsPerPage = 10;
        let filteredRecords = [];
        let currentFilter = 'all';
        
        // Auto-refresh interval for lecturer dashboard
        let autoRefreshInterval = null;
        let lastSyncTime = new Date();
        let isSyncing = false;
        
        // Session management - Track active devices
        let sessionId = null;
        let activeSessions = {};
        
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Generate a unique session ID for this device
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Get device info
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let deviceType = 'Desktop';
            let deviceName = 'Unknown';
            
            if (/Mobile|Android|iPhone|iPad|iPod/.test(ua)) {
                deviceType = 'Mobile';
                if (/iPhone/.test(ua)) deviceName = 'iPhone';
                else if (/iPad/.test(ua)) deviceName = 'iPad';
                else if (/Android/.test(ua)) deviceName = 'Android';
                else deviceName = 'Mobile Device';
            } else {
                if (/Windows/.test(ua)) deviceName = 'Windows PC';
                else if (/Mac/.test(ua)) deviceName = 'Mac';
                else if (/Linux/.test(ua)) deviceName = 'Linux PC';
                else deviceName = 'Desktop';
            }
            
            return {
                type: deviceType,
                name: deviceName,
                userAgent: ua,
                screen: `${window.screen.width}x${window.screen.height}`,
                timestamp: Date.now()
            };
        }
        
        // Update device count indicator
        function updateDeviceCount() {
            const deviceIndicator = document.getElementById('deviceIndicator');
            const studentDeviceCount = document.getElementById('studentDeviceCount');
            
            if (!currentUser) return;
            
            const count = Object.keys(activeSessions).length;
            
            if (deviceIndicator) {
                deviceIndicator.classList.remove('hidden');
                document.getElementById('deviceCount').textContent = count;
            }
            
            if (studentDeviceCount) {
                studentDeviceCount.textContent = count === 1 ? '1 device' : `${count} devices`;
            }
        }
        
        // Sync session state to cloud
        async function syncSessionState() {
            if (!currentUser || !navigator.onLine) return;
            
            const deviceInfo = getDeviceInfo();
            
            // Add or update this session
            activeSessions[sessionId] = {
                deviceInfo: deviceInfo,
                lastActive: Date.now(),
                userId: currentUser.id
            };
            
            // Clean up stale sessions (older than 5 minutes)
            const now = Date.now();
            Object.keys(activeSessions).forEach(id => {
                if (now - activeSessions[id].lastActive > 300000) { // 5 minutes
                    delete activeSessions[id];
                }
            });
            
            // Store session data in a separate cloud bin or as part of user data
            const sessionData = {
                sessions: activeSessions,
                timestamp: now
            };
            
            // We'll store this in localStorage and sync as part of user data
            localStorage.setItem('activeSessions', JSON.stringify(sessionData));
            
            // Also store in user's metadata
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].lastActive = now;
                users[userIndex].lastDevice = deviceInfo;
                users[userIndex].activeSessions = users[userIndex].activeSessions || {};
                users[userIndex].activeSessions[sessionId] = {
                    deviceInfo: deviceInfo,
                    lastActive: now
                };
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            await syncToCloud();
            updateDeviceCount();
        }
        
        // Enhanced Remote Storage Functions
        async function syncToCloud() {
            if (!navigator.onLine) {
                console.log('Offline: Data saved locally only');
                showFlashMessage('You are offline. Data will sync when connection is restored.', 'warning');
                return false;
            }
            
            if (isSyncing) {
                console.log('Sync already in progress');
                return false;
            }
            
            isSyncing = true;
            showSyncIndicator('syncing');
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const attendance = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const sessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
            
            const data = {
                users: users,
                attendance: attendance,
                sessions: sessions,
                timestamp: Date.now(),
                syncDevice: navigator.userAgent,
                syncTime: new Date().toISOString()
            };
            
            try {
                const response = await fetch(REMOTE_STORAGE_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Data synced to cloud:', result);
                    localStorage.setItem('lastCloudSync', Date.now().toString());
                    lastSyncTime = new Date();
                    updateLastSyncTime();
                    showSyncIndicator('synced');
                    isSyncing = false;
                    return true;
                } else {
                    throw new Error('Failed to sync to cloud');
                }
            } catch (error) {
                console.error('Sync failed:', error);
                showSyncIndicator('error');
                isSyncing = false;
                return false;
            }
        }
        
        async function syncFromCloud() {
            if (!navigator.onLine) {
                console.log('Offline: Using local data');
                showFlashMessage('You are offline. Using locally stored data.', 'warning');
                return false;
            }
            
            if (isSyncing) {
                console.log('Sync already in progress');
                return false;
            }
            
            isSyncing = true;
            showSyncIndicator('syncing');
            
            try {
                const response = await fetch(REMOTE_STORAGE_URL + '/latest', {
                    headers: {
                        'X-Master-Key': API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch from cloud');
                }
                
                const data = await response.json();
                
                if (data.record) {
                    // Store the last cloud timestamp
                    localStorage.setItem('lastCloudSync', data.record.timestamp || Date.now());
                    
                    // IMPROVED MERGE ALGORITHM - Better handling of user data
                    const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
                    const remoteUsers = data.record.users || [];
                    
                    // Create maps for better merging
                    const userMap = new Map();
                    
                    // Add local users first
                    localUsers.forEach(user => {
                        userMap.set(user.id, {
                            ...user,
                            _source: 'local',
                            _timestamp: user.updatedAt || user.createdAt || 0
                        });
                    });
                    
                    // Merge with remote users, preferring the one with later timestamp
                    remoteUsers.forEach(remoteUser => {
                        const existingUser = userMap.get(remoteUser.id);
                        const remoteTimestamp = remoteUser.updatedAt || remoteUser.createdAt || 0;
                        
                        if (!existingUser) {
                            userMap.set(remoteUser.id, {
                                ...remoteUser,
                                _source: 'remote'
                            });
                        } else {
                            const localTimestamp = existingUser._timestamp;
                            if (remoteTimestamp > localTimestamp) {
                                userMap.set(remoteUser.id, {
                                    ...remoteUser,
                                    _source: 'remote'
                                });
                            }
                        }
                    });
                    
                    // Convert back to array and clean up _source and _timestamp
                    const mergedUsers = Array.from(userMap.values()).map(user => {
                        const { _source, _timestamp, ...cleanUser } = user;
                        return cleanUser;
                    });
                    
                    // Merge attendance records by ID
                    const localAttendance = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
                    const remoteAttendance = data.record.attendance || [];
                    
                    const attendanceMap = new Map();
                    
                    // Add local attendance
                    localAttendance.forEach(record => {
                        attendanceMap.set(record.id, record);
                    });
                    
                    // Add remote attendance (overwrites local if same ID)
                    remoteAttendance.forEach(record => {
                        attendanceMap.set(record.id, record);
                    });
                    
                    const mergedAttendance = Array.from(attendanceMap.values());
                    
                    // Sort attendance by timestamp (newest first)
                    mergedAttendance.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Merge session data
                    const localSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                    const remoteSessions = data.record.sessions || {};
                    
                    // Merge sessions, preferring newer timestamps
                    const mergedSessions = { ...localSessions };
                    
                    Object.keys(remoteSessions).forEach(sessionId => {
                        if (!mergedSessions[sessionId] || 
                            remoteSessions[sessionId].lastActive > mergedSessions[sessionId].lastActive) {
                            mergedSessions[sessionId] = remoteSessions[sessionId];
                        }
                    });
                    
                    // Save merged data
                    localStorage.setItem('users', JSON.stringify(mergedUsers));
                    localStorage.setItem('attendanceRecords', JSON.stringify(mergedAttendance));
                    localStorage.setItem('activeSessions', JSON.stringify(mergedSessions));
                    
                    lastSyncTime = new Date();
                    updateLastSyncTime();
                    
                    console.log('Data loaded from cloud:', {
                        users: mergedUsers.length,
                        attendance: mergedAttendance.length,
                        sessions: Object.keys(mergedSessions).length
                    });
                    
                    // Update current user if logged in
                    if (currentUser) {
                        const updatedUser = mergedUsers.find(u => u.id === currentUser.id);
                        if (updatedUser) {
                            // Keep the password from current session if it matches
                            if (updatedUser.password === currentUser.password) {
                                currentUser = updatedUser;
                            } else {
                                // Password changed? This might indicate an issue
                                console.warn('Password mismatch for user', currentUser.id);
                                // Still update other fields but keep current password
                                currentUser = { ...updatedUser, password: currentUser.password };
                            }
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }
                        
                        // Update active sessions from merged data
                        activeSessions = mergedSessions;
                        
                        // Check if this session was logged out from another device
                        if (!activeSessions[sessionId] && currentUser) {
                            console.log('Session terminated from another device');
                            showFlashMessage('You have been logged out from another device', 'warning');
                            logout();
                            return false;
                        }
                        
                        // Refresh session state
                        await syncSessionState();
                        updateDeviceCount();
                    }
                    
                    showSyncIndicator('synced');
                    isSyncing = false;
                    
                    // Show success message with record count
                    showFlashMessage(`Synced ${mergedAttendance.length} attendance records from cloud`, 'success');
                    
                    return true;
                }
            } catch (error) {
                console.error('Sync failed:', error);
                showSyncIndicator('error');
                isSyncing = false;
                return false;
            }
        }
        
        // Improved syncData function that ensures bidirectional sync
        async function syncData(force = false) {
            if (!navigator.onLine) {
                console.log('Offline: Cannot sync');
                return false;
            }
            
            if (isSyncing) {
                console.log('Sync already in progress');
                return false;
            }
            
            try {
                // First pull from cloud to get latest data
                const pullSuccess = await syncFromCloud();
                
                // Then push local changes to cloud
                const pushSuccess = await syncToCloud();
                
                // If we're in lecturer dashboard, refresh the table
                if (currentUser && currentUser.role === 'lecturer' && document.getElementById('lecturerDashboardView').classList.contains('active')) {
                    await refreshAttendanceTable();
                }
                
                // If we're in student dashboard, refresh recent attendance
                if (currentUser && currentUser.role === 'student' && document.getElementById('studentDashboardView').classList.contains('active')) {
                    loadStudentDashboard();
                }
                
                return pullSuccess && pushSuccess;
            } catch (error) {
                console.error('Sync error:', error);
                return false;
            }
        }
        
        // Force cloud sync (manual trigger)
        async function forceCloudSync() {
            showFlashMessage('Syncing with cloud...', 'info');
            const syncSuccess = await syncData();
            if (syncSuccess) {
                showFlashMessage('Sync completed successfully!', 'success');
            } else {
                showFlashMessage('Sync failed. Please check your internet connection.', 'error');
            }
        }
        
        // Show sync indicator
        function showSyncIndicator(status) {
            const lastSyncElement = document.getElementById('lastSyncTime');
            if (!lastSyncElement) return;
            
            const parent = lastSyncElement.parentElement;
            if (!parent) return;
            
            // Remove existing indicators
            const existingIndicator = parent.querySelector('.sync-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const indicator = document.createElement('span');
            indicator.className = `sync-indicator ${status} ml-2`;
            
            if (status === 'syncing') {
                indicator.innerHTML = '<span class="material-symbols-outlined text-sm animate-spin">sync</span> Syncing...';
            } else if (status === 'synced') {
                indicator.innerHTML = '<span class="material-symbols-outlined text-sm">check_circle</span> Synced';
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 3000);
            } else if (status === 'error') {
                indicator.innerHTML = '<span class="material-symbols-outlined text-sm">error</span> Sync failed';
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 3000);
            }
            
            parent.appendChild(indicator);
        }
        
        function updateLastSyncTime() {
            const now = new Date();
            const diffMs = now - lastSyncTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            let timeText = '';
            if (diffMins < 1) {
                timeText = 'Just now';
            } else if (diffMins < 60) {
                timeText = `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
            } else {
                const diffHours = Math.floor(diffMins / 60);
                timeText = `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            }
            
            const lastSyncElement = document.getElementById('lastSyncTime');
            if (lastSyncElement) {
                lastSyncElement.textContent = timeText;
            }
        }
        
        // Start auto-refresh for lecturer dashboard
        function startAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (!autoRefreshCheckbox) return;
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(async () => {
                    if (navigator.onLine) {
                        await syncData();
                    }
                }, 10000); // Sync every 10 seconds for better real-time sync
                
                console.log('Auto-refresh started');
            }
        }
        
        // Theme toggle function
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                themeIcon.textContent = 'dark_mode';
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                themeIcon.textContent = 'light_mode';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Check for saved theme preference
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = 'light_mode';
            } else {
                document.documentElement.classList.add('light');
                themeIcon.textContent = 'dark_mode';
            }
        }
        
        // View management
        function showView(viewName) {
            console.log('Showing view:', viewName);
            // Hide all views
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            const viewElement = document.getElementById(viewName + 'View');
            if (viewElement) {
                viewElement.classList.add('active');
                console.log('View element found and activated:', viewName + 'View');
            } else {
                console.error('View element not found:', viewName + 'View');
            }
            
            // Update navigation
            updateNavigation(viewName);
            
            // Initialize view-specific functionality
            initializeView(viewName);
        }
        
        function updateNavigation(viewName) {
            const authLinks = document.getElementById('authLinks');
            const userInfo = document.getElementById('userInfo');
            const userRole = document.getElementById('userRole');
            
            if (currentUser) {
                authLinks.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userRole.textContent = `${currentUser.fullName} (${currentUser.role})`;
            } else {
                authLinks.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }
        
        function initializeView(viewName) {
            console.log('Initializing view:', viewName);
            switch(viewName) {
                case 'studentDashboard':
                    loadStudentDashboard();
                    break;
                case 'lecturerDashboard':
                    loadLecturerDashboard();
                    break;
                case 'adminDashboard':
                    loadAdminDashboard();
                    break;
                case 'signup':
                    selectRole('student');
                    break;
                default:
                    console.log('No specific initialization for view:', viewName);
            }
        }
        
        // Authentication functions - IMPROVED with better sync and session management
        async function login(username, password) {
            console.log('Login attempt for:', username);
            
            // First sync from cloud to get latest users - IMPORTANT: Wait for this to complete
            if (navigator.onLine) {
                showFlashMessage('Syncing user data from cloud...', 'info');
                await syncFromCloud();
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            console.log('Total users after sync:', users.length);
            
            // Find user by username OR matric number
            const user = users.find(u => u.username === username || u.matricNumber === username);
            
            if (user && user.password === password) {
                // Check if lecturer is approved
                if (user.role === 'lecturer' && !user.isApproved) {
                    showFlashMessage('Your account is pending approval by administrator', 'error');
                    return false;
                }
                
                // Generate session ID for this device
                sessionId = generateSessionId();
                const deviceInfo = getDeviceInfo();
                
                // Initialize active sessions
                activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                
                // Add this session
                activeSessions[sessionId] = {
                    deviceInfo: deviceInfo,
                    lastActive: Date.now(),
                    userId: user.id
                };
                
                // Clean up stale sessions for this user
                const now = Date.now();
                Object.keys(activeSessions).forEach(id => {
                    if (activeSessions[id].userId === user.id && 
                        now - activeSessions[id].lastActive > 300000) { // 5 minutes
                        delete activeSessions[id];
                    }
                });
                
                localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                
                currentUser = {
                    ...user,
                    sessionId: sessionId,
                    deviceInfo: deviceInfo,
                    loginTime: now
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('User logged in:', user.role, 'Session:', sessionId);
                
                // Update user's last active and device info
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex].lastActive = now;
                    users[userIndex].lastDevice = deviceInfo;
                    users[userIndex].activeSessions = activeSessions;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Sync data after login to get any new attendance records and update session info
                setTimeout(async () => {
                    await syncData();
                    updateDeviceCount();
                }, 1000);
                
                // Redirect to appropriate dashboard
                let dashboardView = '';
                switch(user.role) {
                    case 'student':
                        dashboardView = 'studentDashboard';
                        break;
                    case 'lecturer':
                        dashboardView = 'lecturerDashboard';
                        break;
                    case 'admin':
                        dashboardView = 'adminDashboard';
                        break;
                    default:
                        dashboardView = 'home';
                }
                
                showFlashMessage(`Login successful! Welcome from ${deviceInfo.name}`, 'success');
                console.log('Redirecting to:', dashboardView);
                showView(dashboardView);
                
                // Start periodic session updates
                setInterval(async () => {
                    if (currentUser) {
                        await syncSessionState();
                    }
                }, 30000); // Update every 30 seconds
                
                return true;
            } else {
                showFlashMessage('Invalid username or password', 'error');
                return false;
            }
        }
        
        function logout() {
            // Remove this session from active sessions
            if (sessionId && activeSessions[sessionId]) {
                delete activeSessions[sessionId];
                localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                
                // Update user's active sessions
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser?.id);
                if (userIndex !== -1) {
                    users[userIndex].activeSessions = activeSessions;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Sync to cloud
                if (navigator.onLine) {
                    syncToCloud();
                }
            }
            
            // Stop auto-refresh if running
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            currentUser = null;
            sessionId = null;
            localStorage.removeItem('currentUser');
            showView('home');
            showFlashMessage('You have been logged out successfully.', 'success');
        }
        
        async function signup(userData) {
            console.log('Signup attempt for:', userData.username);
            
            // First sync from cloud to check for existing users
            if (navigator.onLine) {
                await syncFromCloud();
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Check if username already exists
            if (users.find(u => u.username === userData.username)) {
                showFlashMessage('Username already exists', 'error');
                return false;
            }
            
            // Check if matric number already exists for students
            if (userData.role === 'student' && users.find(u => u.matricNumber === userData.matricNumber)) {
                showFlashMessage('Matric number already registered', 'error');
                return false;
            }
            
            // Add timestamps for better merge handling
            userData.createdAt = new Date().toISOString();
            userData.updatedAt = new Date().toISOString();
            
            // Add the new user
            users.push(userData);
            localStorage.setItem('users', JSON.stringify(users));
            
            // IMPORTANT FIX: Sync to cloud immediately after signup and wait for completion
            let syncSuccess = false;
            if (navigator.onLine) {
                showFlashMessage('Syncing account to cloud...', 'info');
                syncSuccess = await syncToCloud();
                
                // Double sync to ensure data is propagated
                if (syncSuccess) {
                    await syncToCloud(); // Second sync for redundancy
                    showFlashMessage('Account created and synced to cloud successfully!', 'success');
                } else {
                    showFlashMessage('Account created locally. Will sync when online.', 'warning');
                }
            } else {
                showFlashMessage('Account created locally. Please connect to internet to sync.', 'warning');
            }
            
            // Auto-login after signup (except for lecturers)
            if (userData.role !== 'lecturer') {
                // Small delay to ensure sync is complete
                setTimeout(async () => {
                    await login(userData.username, userData.password);
                }, 1000);
            } else {
                // For lecturers, redirect to login with message
                setTimeout(() => {
                    showFlashMessage('Your account is pending approval by administrator', 'info');
                    showView('login');
                }, 1500);
            }
            
            return true;
        }
        
        // Password reset function
        function resetPassword(username) {
            // In a real implementation, this would send an email
            // For demo purposes, we'll just show a message
            showFlashMessage(`Password reset link sent to ${username}@student.nsuk.edu.ng`, 'success');
            setTimeout(() => {
                showView('login');
            }, 2000);
        }
        
        // Student Dashboard Functions - IMPROVED with cloud sync
        async function loadStudentDashboard() {
            console.log('Loading student dashboard...');
            if (!currentUser || currentUser.role !== 'student') {
                showFlashMessage('Access denied. Please login as student.', 'error');
                showView('home');
                return;
            }
            
            // Sync from cloud to get latest attendance records and session info
            if (navigator.onLine) {
                await syncFromCloud();
            }
            
            document.getElementById('studentName').textContent = `Welcome, ${currentUser.fullName}!`;
            document.getElementById('studentFullName').textContent = currentUser.fullName;
            document.getElementById('studentMatric').textContent = currentUser.matricNumber;
            document.getElementById('studentFullNameInput').value = currentUser.fullName;
            document.getElementById('studentMatricInput').value = currentUser.matricNumber;
            
            // Update device count
            updateDeviceCount();
            
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const studentRecords = records.filter(r => r.studentId === currentUser.id);
            
            const recentAttendance = document.getElementById('recentAttendance');
            if (studentRecords.length > 0) {
                recentAttendance.innerHTML = studentRecords.slice(0, 5).map(record => {
                    // Check if this record came from another device
                    const fromOtherDevice = record.sessionId && record.sessionId !== sessionId;
                    
                    return `
                    <div class="border-l-4 ${fromOtherDevice ? 'border-purple-500' : 'border-primary'} pl-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-900/50 rounded-r-xl">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-medium text-slate-900 dark:text-white">${record.courseCode}</p>
                            <span class="text-xs text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-2 py-1 rounded-full">Present</span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400">
                            ${new Date(record.timestamp).toLocaleDateString()} at ${new Date(record.timestamp).toLocaleTimeString()}
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-500 mt-1">
                            <span class="material-symbols-outlined align-middle text-xs">location_on</span>
                            ${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}
                        </p>
                        <div class="flex items-center mt-1 space-x-2">
                            ${record.synced ? 
                                '<span class="text-xs text-green-600 dark:text-green-400 flex items-center"><span class="material-symbols-outlined text-xs mr-1">cloud_done</span>Cloud-synced</span>' : 
                                '<span class="text-xs text-yellow-600 dark:text-yellow-400 flex items-center"><span class="material-symbols-outlined text-xs mr-1">cloud_off</span>Pending sync</span>'}
                            ${fromOtherDevice ? 
                                '<span class="text-xs text-purple-600 dark:text-purple-400 flex items-center"><span class="material-symbols-outlined text-xs mr-1">devices</span>From another device</span>' : ''}
                        </div>
                    </div>
                `}).join('');
            } else {
                recentAttendance.innerHTML = `
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-slate-400 mb-4">history</span>
                        <p class="text-slate-500 dark:text-slate-400">No attendance records yet</p>
                        <p class="text-sm text-slate-500 dark:text-slate-500 mt-2">Submit your first attendance above</p>
                    </div>
                `;
            }
            
            resetStudentForm();
        }
        
        function resetStudentForm() {
            isLocationCaptured = false;
            isFaceCaptured = false;
            isCourseSelected = false;
            currentLocation = null;
            faceImage = null;
            
            document.getElementById('locationStatus').innerHTML = `
                <span class="material-symbols-outlined align-middle text-yellow-600">pending</span>Location not captured yet
            `;
            document.getElementById('coordinates').classList.add('hidden');
            
            document.getElementById('facePreview').classList.add('hidden');
            document.getElementById('captureFace').classList.remove('hidden');
            document.getElementById('retakePhoto').classList.add('hidden');
            document.getElementById('noCamera').classList.remove('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('captureFace').disabled = true;
            
            document.getElementById('courseCode').value = '';
            
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const locationCheck = document.getElementById('locationCheck');
            const faceCheck = document.getElementById('faceCheck');
            const courseCheck = document.getElementById('courseCheck');
            const courseCode = document.getElementById('courseCode').value;
            
            if (isLocationCaptured) {
                locationCheck.textContent = 'check_circle';
                locationCheck.className = 'material-symbols-outlined text-green-500 mr-2 text-sm';
            } else {
                locationCheck.textContent = 'radio_button_unchecked';
                locationCheck.className = 'material-symbols-outlined text-red-500 mr-2 text-sm';
            }
            
            if (isFaceCaptured) {
                faceCheck.textContent = 'check_circle';
                faceCheck.className = 'material-symbols-outlined text-green-500 mr-2 text-sm';
            } else {
                faceCheck.textContent = 'radio_button_unchecked';
                faceCheck.className = 'material-symbols-outlined text-red-500 mr-2 text-sm';
            }
            
            if (courseCode) {
                courseCheck.textContent = 'check_circle';
                courseCheck.className = 'material-symbols-outlined text-green-500 mr-2 text-sm';
                isCourseSelected = true;
            } else {
                courseCheck.textContent = 'radio_button_unchecked';
                courseCheck.className = 'material-symbols-outlined text-red-500 mr-2 text-sm';
                isCourseSelected = false;
            }
            
            if (isLocationCaptured && isFaceCaptured && isCourseSelected) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }
        
        // Student-specific functions
        function captureLocation() {
            if (navigator.geolocation) {
                const btn = document.getElementById('captureLocation');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">sync</span>Capturing...';
                btn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        
                        document.getElementById('locationStatus').innerHTML = `
                            <span class="material-symbols-outlined align-middle text-green-600">check_circle</span>Location captured successfully
                        `;
                        document.getElementById('coordinates').classList.remove('hidden');
                        document.getElementById('latitude').textContent = currentLocation.lat.toFixed(6);
                        document.getElementById('longitude').textContent = currentLocation.lon.toFixed(6);
                        
                        isLocationCaptured = true;
                        updateSubmitButton();
                        
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    },
                    error => {
                        showFlashMessage('Error capturing location: ' + error.message, 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                );
            } else {
                showFlashMessage('Geolocation is not supported by your browser', 'error');
            }
        }
        
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const btn = document.getElementById('startCamera');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">sync</span>Starting...';
                btn.disabled = true;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(stream => {
                    videoStream = stream;
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    
                    document.getElementById('cameraContainer').classList.remove('hidden');
                    document.getElementById('noCamera').classList.add('hidden');
                    document.getElementById('captureFace').disabled = false;
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                })
                .catch(error => {
                    showFlashMessage('Could not access camera: ' + error.message, 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }
        
        function captureFace() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            faceImage = canvas.toDataURL('image/jpeg', 0.8);
            
            const preview = document.getElementById('facePreview');
            const capturedImage = document.getElementById('capturedImage');
            capturedImage.src = faceImage;
            preview.classList.remove('hidden');
            
            document.getElementById('captureFace').classList.add('hidden');
            document.getElementById('retakePhoto').classList.remove('hidden');
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            isFaceCaptured = true;
            updateSubmitButton();
        }
        
        function retakePhoto() {
            document.getElementById('facePreview').classList.add('hidden');
            document.getElementById('captureFace').classList.remove('hidden');
            document.getElementById('retakePhoto').classList.add('hidden');
            document.getElementById('noCamera').classList.remove('hidden');
            document.getElementById('cameraContainer').classList.add('hidden');
            
            faceImage = null;
            isFaceCaptured = false;
            updateSubmitButton();
            
            document.getElementById('startCamera').innerHTML = '<span class="material-symbols-outlined mr-2">videocam</span>Start Camera';
            document.getElementById('startCamera').disabled = false;
        }
        
        async function submitAttendance() {
            const courseCode = document.getElementById('courseCode').value;
            
            if (!currentLocation || !faceImage || !courseCode) {
                showFlashMessage('Please complete all steps before submitting', 'error');
                return;
            }
            
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const recordId = Date.now();
            const timestamp = new Date().toISOString();
            
            const attendanceRecord = {
                id: recordId,
                studentId: currentUser.id,
                studentName: currentUser.fullName,
                matricNumber: currentUser.matricNumber,
                courseCode: courseCode,
                latitude: currentLocation.lat,
                longitude: currentLocation.lon,
                faceImage: faceImage,
                timestamp: timestamp,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                submittedFrom: navigator.userAgent,
                deviceType: getDeviceInfo().type,
                deviceName: getDeviceInfo().name,
                sessionId: sessionId,
                synced: false,
                createdAt: timestamp
            };
            
            records.push(attendanceRecord);
            localStorage.setItem('attendanceRecords', JSON.stringify(records));
            
            // Sync to cloud after attendance submission
            let syncSuccess = false;
            if (navigator.onLine) {
                showFlashMessage('Syncing attendance to cloud...', 'info');
                syncSuccess = await syncToCloud();
                if (syncSuccess) {
                    // Update the record to mark as synced
                    attendanceRecord.synced = true;
                    // Update in localStorage
                    const updatedRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
                    const recordIndex = updatedRecords.findIndex(r => r.id === recordId);
                    if (recordIndex !== -1) {
                        updatedRecords[recordIndex].synced = true;
                        localStorage.setItem('attendanceRecords', JSON.stringify(updatedRecords));
                    }
                    showFlashMessage(`Attendance submitted successfully! Course: ${courseCode} (Synced to cloud)`, 'success');
                } else {
                    showFlashMessage(`Attendance submitted successfully! Course: ${courseCode} (Saved locally, will sync when online)`, 'warning');
                }
            } else {
                showFlashMessage(`Attendance submitted successfully! Course: ${courseCode} (Saved locally, will sync when online)`, 'warning');
            }
            
            // Clear form
            resetStudentForm();
            
            // Reload student dashboard to show updated records
            setTimeout(() => {
                loadStudentDashboard();
            }, 1500);
        }
        
        // Lecturer Dashboard Functions - Enhanced for cross-device visibility
        async function loadLecturerDashboard() {
            console.log('Loading lecturer dashboard...');
            if (!currentUser || currentUser.role !== 'lecturer') {
                showFlashMessage('Access denied. Please login as lecturer.', 'error');
                showView('home');
                return;
            }
            
            document.getElementById('lecturerName').textContent = `Welcome, ${currentUser.fullName}!`;
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Force initial sync from cloud to get all attendance records
            if (navigator.onLine) {
                showFlashMessage('Syncing attendance records from cloud...', 'info');
                await syncFromCloud();
            }
            
            // Load attendance table
            await refreshAttendanceTable();
        }
        
        async function refreshAttendanceTable() {
            // Force sync from cloud first to get latest data from other devices
            if (navigator.onLine) {
                await syncFromCloud();
            }
            
            // Get all attendance records from localStorage (now updated with cloud data)
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            
            console.log('Total attendance records after sync:', records.length);
            
            // Calculate statistics
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(r => r.date === today);
            
            // Get unique students
            const uniqueStudents = new Set(records.map(r => r.studentId)).size;
            
            // Update dashboard stats
            document.getElementById('totalStudents').textContent = uniqueStudents;
            document.getElementById('presentToday').textContent = todayRecords.length.toString();
            document.getElementById('activeSessions').textContent = Object.keys(activeSessions).length.toString();
            
            // Load attendance table
            loadSubmittedAttendanceTable(records);
            
            // Update sync time
            updateLastSyncTime();
            
            showFlashMessage(`Loaded ${records.length} attendance records from all devices`, 'success');
        }
        
        function loadSubmittedAttendanceTable(allRecords) {
            console.log('Loading attendance table with', allRecords.length, 'records');
            
            // Sort records by timestamp (newest first)
            allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Reset pagination
            currentPage = 1;
            currentFilter = document.getElementById('courseFilter').value;
            
            // Apply filter
            if (currentFilter === 'all') {
                filteredRecords = [...allRecords];
            } else {
                filteredRecords = allRecords.filter(record => record.courseCode === currentFilter);
            }
            
            renderAttendanceTable();
        }
        
        function filterAttendanceByCourse() {
            const filterValue = document.getElementById('courseFilter').value;
            const allRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            
            // Sort records by timestamp (newest first)
            allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filterValue === 'all') {
                filteredRecords = [...allRecords];
            } else {
                filteredRecords = allRecords.filter(record => record.courseCode === filterValue);
            }
            
            currentFilter = filterValue;
            currentPage = 1;
            renderAttendanceTable();
        }
        
        function renderAttendanceTable() {
            const submittedAttendance = document.getElementById('submittedAttendance');
            const noSubmittedRecords = document.getElementById('noSubmittedRecords');
            const attendanceCount = document.getElementById('attendanceCount');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (filteredRecords.length === 0) {
                if (noSubmittedRecords) noSubmittedRecords.style.display = '';
                if (submittedAttendance) submittedAttendance.innerHTML = '';
                if (attendanceCount) attendanceCount.textContent = 'Showing 0 records';
                if (pageInfo) pageInfo.textContent = 'Page 1 of 1';
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                return;
            }
            
            if (noSubmittedRecords) noSubmittedRecords.style.display = 'none';
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            // Render table rows
            submittedAttendance.innerHTML = pageRecords.map(record => {
                // Determine if record is from another device
                const isFromOtherDevice = record.sessionId && record.sessionId !== sessionId;
                
                return `
                <tr class="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors">
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            ${record.studentName}
                            ${record.deviceType === 'Mobile' ? 
                                '<span class="ml-2 material-symbols-outlined text-sm text-blue-500" title="Submitted from mobile">smartphone</span>' : 
                                '<span class="ml-2 material-symbols-outlined text-sm text-green-500" title="Submitted from desktop">computer</span>'}
                            ${record.synced ? 
                                '<span class="ml-2 material-symbols-outlined text-sm text-green-500" title="Cloud synced">cloud_done</span>' : 
                                '<span class="ml-2 material-symbols-outlined text-sm text-yellow-500" title="Not synced">cloud_off</span>'}
                            ${isFromOtherDevice ? 
                                '<span class="ml-2 material-symbols-outlined text-sm text-purple-500" title="From another device">devices</span>' : ''}
                        </div>
                        ${record.deviceName ? `<div class="text-xs text-slate-500 mt-1">${record.deviceName}</div>` : ''}
                    </td>
                    <td class="py-3 px-4 font-mono">${record.matricNumber}</td>
                    <td class="py-3 px-4">
                        <span class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs px-2 py-1 rounded">${record.courseCode}</span>
                    </td>
                    <td class="py-3 px-4">${record.date}</td>
                    <td class="py-3 px-4">${record.time}</td>
                    <td class="py-3 px-4 font-mono text-xs">
                        ${record.longitude.toFixed(4)}, ${record.latitude.toFixed(4)}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button onclick="viewFaceImage('${record.id}')" class="text-primary hover:text-primary-hover transition-colors p-1 rounded hover:bg-blue-50 dark:hover:bg-blue-900/20" title="View Face">
                                <span class="material-symbols-outlined align-middle">visibility</span>
                            </button>
                            <button onclick="downloadRecordAsPDF('${record.id}')" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 transition-colors p-1 rounded hover:bg-green-50 dark:hover:bg-green-900/20" title="Download as PDF">
                                <span class="material-symbols-outlined align-middle">picture_as_pdf</span>
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20" title="Delete">
                                <span class="material-symbols-outlined align-middle">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            // Update pagination info
            attendanceCount.textContent = `Showing ${startIndex + 1}-${Math.min(endIndex, filteredRecords.length)} of ${filteredRecords.length} records`;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAttendanceTable();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderAttendanceTable();
            }
        }
        
        function viewFaceImage(recordId) {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const record = records.find(r => r.id == recordId);
            
            if (record && record.faceImage) {
                const newWindow = window.open();
                newWindow.document.write(`
                    <html>
                    <head><title>Face Image - ${record.studentName}</title>
                    <style>
                        body { margin:0; padding:20px; background:#f5f5f5; display:flex; justify-content:center; align-items:center; min-height:100vh; font-family:Arial,sans-serif; }
                        .container { text-align:center; max-width:90vw; }
                        img { max-width:80vw; max-height:80vh; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.2); }
                        .info { margin-top:20px; background:white; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
                        .device-info { color:#666; font-size:14px; margin-top:5px; }
                    </style>
                    </head>
                    <body>
                        <div class="container">
                            <img src="${record.faceImage}" alt="Face Image">
                            <div class="info">
                                <p><strong>${record.studentName} - ${record.matricNumber}</strong></p>
                                <p>${record.courseCode} - ${record.date} ${record.time}</p>
                                <p class="device-info">Submitted from: ${record.deviceName || record.deviceType || 'Unknown device'}</p>
                                <p class="device-info">Location: ${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}</p>
                                <p class="device-info">Cloud Sync: ${record.synced ? 'Yes' : 'Pending'}</p>
                                <p class="device-info">Device ID: ${record.sessionId ? record.sessionId.substring(0, 8) + '...' : 'Unknown'}</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
            } else {
                showFlashMessage('Face image not found for this record', 'error');
            }
        }
        
        // PDF Download function for single record
        function downloadRecordAsPDF(recordId) {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const record = records.find(r => r.id == recordId);
            
            if (record) {
                try {
                    // Create a new jsPDF instance
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Add title with styling
                    doc.setFontSize(24);
                    doc.setTextColor(15, 27, 61); // Primary color
                    doc.setFont("helvetica", "bold");
                    doc.text('ATTENDANCE RECORD', 148, 20, { align: 'center' });
                    
                    // Add NSUK header
                    doc.setFontSize(12);
                    doc.setTextColor(100);
                    doc.setFont("helvetica", "normal");
                    doc.text('Nasarawa State University, Keffi', 148, 30, { align: 'center' });
                    doc.text('Department of Urban and Regional Planning', 148, 36, { align: 'center' });
                    
                    // Add line
                    doc.setDrawColor(15, 27, 61);
                    doc.setLineWidth(0.5);
                    doc.line(20, 42, 277, 42);
                    
                    // Add metadata
                    doc.setFontSize(10);
                    doc.setTextColor(80);
                    doc.setFont("helvetica", "italic");
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 148, 50, { align: 'center' });
                    doc.text(`Generated by: ${currentUser.fullName} (${currentUser.role})`, 148, 56, { align: 'center' });
                    
                    // Prepare data for the main table - Single row with all fields as columns
                    const tableData = [[
                        record.studentName,
                        record.matricNumber,
                        record.courseCode,
                        record.date,
                        record.time,
                        `${record.latitude.toFixed(6)}, ${record.longitude.toFixed(6)}`,
                        record.deviceName || record.deviceType || 'Unknown',
                        record.submittedFrom ? record.submittedFrom.substring(0, 30) + '...' : 'Unknown'
                    ]];
                    
                    // Add main attendance table
                    doc.autoTable({
                        startY: 65,
                        head: [['Student Name', 'Matric No.', 'Course', 'Date', 'Time', 'Location', 'Device', 'Submitted From']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [15, 27, 61],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center',
                            fontSize: 10
                        },
                        styles: {
                            fontSize: 9,
                            cellPadding: 4,
                            overflow: 'linebreak',
                            valign: 'middle'
                        },
                        columnStyles: {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 20 },
                            3: { cellWidth: 20 },
                            4: { cellWidth: 18 },
                            5: { cellWidth: 40 },
                            6: { cellWidth: 20 },
                            7: { cellWidth: 55 }
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        }
                    });
                    
                    // Add verification details in a separate table
                    const verificationY = doc.lastAutoTable.finalY + 15;
                    
                    doc.setFontSize(16);
                    doc.setTextColor(15, 27, 61);
                    doc.setFont("helvetica", "bold");
                    doc.text('Verification Details', 20, verificationY);
                    
                    const verificationData = [
                        ['Face Verification', 'âœ“ Verified', 'Live Capture', 'Success'],
                        ['Location Verification', 'âœ“ Verified', 'GPS Coordinates', 'High Accuracy'],
                        ['Timestamp Verification', 'âœ“ Verified', 'System Time', 'Valid'],
                        ['Device Verification', 'âœ“ Verified', record.deviceName || record.deviceType || 'Unknown', 'Authenticated'],
                        ['Cloud Sync', record.synced ? 'âœ“ Synced' : 'â—‹ Pending', 'JSONBin.io', record.synced ? 'Complete' : 'Local Only']
                    ];
                    
                    doc.autoTable({
                        startY: verificationY + 5,
                        head: [['Verification Type', 'Status', 'Method', 'Result']],
                        body: verificationData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [15, 27, 61],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        styles: {
                            fontSize: 9,
                            cellPadding: 4
                        },
                        columnStyles: {
                            0: { cellWidth: 50 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 45 },
                            3: { cellWidth: 40 }
                        },
                        bodyStyles: {
                            textColor: [0, 100, 0]
                        }
                    });
                    
                    // Add download information
                    const downloadY = doc.lastAutoTable.finalY + 15;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(150);
                    doc.setFont("helvetica", "italic");
                    doc.text(`Downloaded on: ${new Date().toLocaleString()}`, 148, downloadY, { align: 'center' });
                    doc.text(`Downloaded by: ${currentUser.fullName} (${currentUser.role})`, 148, downloadY + 5, { align: 'center' });
                    doc.text(`Record ID: ${record.id}`, 148, downloadY + 10, { align: 'center' });
                    
                    // Add footer with verification stamp
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.setFont("helvetica", "normal");
                    doc.text('This is an electronically generated attendance record from NSUK URP E-Attendance System', 148, 195, { align: 'center' });
                    doc.text('Valid without signature â€¢ Cloud-synchronized', 148, 200, { align: 'center' });
                    
                    // Generate filename
                    const filename = `attendance_${record.matricNumber}_${record.date}_${record.time.replace(/:/g, '-')}.pdf`;
                    
                    // Save the PDF
                    doc.save(filename);
                    
                    showFlashMessage('Record downloaded as PDF successfully!', 'success');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    showFlashMessage('Error generating PDF. Please try again.', 'error');
                }
            }
        }

        // Optional: Add a function to download multiple records as PDF
        function downloadMultipleRecordsAsPDF(recordIds) {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const selectedRecords = records.filter(r => recordIds.includes(r.id));
            
            if (selectedRecords.length === 0) {
                showFlashMessage('No records selected', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(15, 27, 61);
                doc.setFont("helvetica", "bold");
                doc.text('ATTENDANCE RECORDS', 148, 20, { align: 'center' });
                
                // Header
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Nasarawa State University, Keffi', 148, 30, { align: 'center' });
                doc.text('Department of Urban and Regional Planning', 148, 36, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleString()}`, 148, 42, { align: 'center' });
                doc.text(`Generated by: ${currentUser.fullName} (${currentUser.role})`, 148, 48, { align: 'center' });
                
                // Prepare data for table
                const tableData = selectedRecords.map(record => [
                    record.studentName,
                    record.matricNumber,
                    record.courseCode,
                    record.date,
                    record.time,
                    `${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}`,
                    record.deviceName || record.deviceType || 'Unknown',
                    record.synced ? 'âœ“' : 'â—‹'
                ]);
                
                // Add table
                doc.autoTable({
                    startY: 55,
                    head: [['Student Name', 'Matric No.', 'Course', 'Date', 'Time', 'Location', 'Device', 'Synced']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [15, 27, 61],
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 3
                    },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 18 },
                        4: { cellWidth: 16 },
                        5: { cellWidth: 35 },
                        6: { cellWidth: 18 },
                        7: { cellWidth: 10 }
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });
                
                // Add summary
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setTextColor(15, 27, 61);
                doc.setFont("helvetica", "bold");
                doc.text(`Total Records: ${selectedRecords.length}`, 20, finalY);
                doc.text(`Downloaded on: ${new Date().toLocaleString()}`, 20, finalY + 6);
                
                // Save the PDF
                doc.save(`attendance_records_${new Date().toISOString().split('T')[0]}.pdf`);
                
                showFlashMessage(`${selectedRecords.length} records downloaded as PDF successfully!`, 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showFlashMessage('Error generating PDF. Please try again.', 'error');
            }
        }
        
        async function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this attendance record?')) {
                const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
                const updatedRecords = records.filter(r => r.id != recordId);
                localStorage.setItem('attendanceRecords', JSON.stringify(updatedRecords));
                
                // Sync to cloud after deletion
                await syncToCloud();
                
                showFlashMessage('Record deleted successfully!', 'success');
                refreshAttendanceTable();
            }
        }
        
        function startSession() {
            showFlashMessage('Starting new session... (Demo)', 'info');
        }
        
        function generateReport() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            
            if (records.length === 0) {
                showFlashMessage('No attendance records to generate report from', 'error');
                return;
            }
            
            try {
                // Create a new jsPDF instance
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.setTextColor(15, 27, 61);
                doc.text('ATTENDANCE REPORT', 105, 20, { align: 'center' });
                
                // Add metadata
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 30, { align: 'center' });
                doc.text(`Generated by: ${currentUser.fullName} (${currentUser.role})`, 105, 36, { align: 'center' });
                doc.text(`Total Records: ${records.length}`, 105, 42, { align: 'center' });
                
                // Group by course and date
                const courseSummary = {};
                records.forEach(record => {
                    const key = `${record.courseCode}_${record.date}`;
                    if (!courseSummary[key]) {
                        courseSummary[key] = {
                            course: record.courseCode,
                            date: record.date,
                            total: 0,
                            students: new Set(),
                            mobileCount: 0,
                            desktopCount: 0,
                            syncedCount: 0
                        };
                    }
                    courseSummary[key].total++;
                    courseSummary[key].students.add(record.studentName);
                    if (record.deviceType === 'Mobile') {
                        courseSummary[key].mobileCount++;
                    } else if (record.deviceType === 'Desktop') {
                        courseSummary[key].desktopCount++;
                    }
                    if (record.synced) {
                        courseSummary[key].syncedCount++;
                    }
                });
                
                // Prepare data for table
                const tableData = Object.values(courseSummary).map(data => [
                    data.course,
                    data.date,
                    data.total,
                    data.students.size,
                    data.mobileCount,
                    data.desktopCount,
                    data.syncedCount
                ]);
                
                // Add table
                doc.autoTable({
                    head: [['Course', 'Date', 'Total', 'Unique Students', 'Mobile', 'Desktop', 'Synced']],
                    body: tableData,
                    startY: 50,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [15, 27, 61],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });
                
                // Add recent records section
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(14);
                doc.setTextColor(15, 27, 61);
                doc.text('Recent Attendance Records', 14, finalY);
                
                // Get recent records for table
                const recentRecords = records.slice(0, 20).map(record => [
                    record.studentName,
                    record.matricNumber,
                    record.courseCode,
                    record.date,
                    record.time,
                    record.deviceName || record.deviceType || 'Unknown',
                    record.synced ? 'Yes' : 'No'
                ]);
                
                doc.autoTable({
                    head: [['Student', 'Matric', 'Course', 'Date', 'Time', 'Device', 'Synced']],
                    body: recentRecords,
                    startY: finalY + 5,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [15, 27, 61],
                        textColor: 255
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3
                    }
                });
                
                // Save the PDF
                doc.save(`attendance_report_${new Date().toISOString().split('T')[0]}.pdf`);
                
                showFlashMessage('Report generated as PDF successfully!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                // Fallback to alert
                let report = 'ATTENDANCE REPORT\n';
                report += 'Generated: ' + new Date().toLocaleString() + '\n';
                report += 'Generated by: ' + currentUser.fullName + '\n';
                report += 'Total Records: ' + records.length + '\n\n';
                report += 'By Course and Date:\n';
                
                // Group by course and date
                const courseSummary = {};
                records.forEach(record => {
                    const key = `${record.courseCode}_${record.date}`;
                    if (!courseSummary[key]) {
                        courseSummary[key] = {
                            course: record.courseCode,
                            date: record.date,
                            total: 0,
                            students: new Set(),
                            mobileCount: 0,
                            desktopCount: 0
                        };
                    }
                    courseSummary[key].total++;
                    courseSummary[key].students.add(record.studentName);
                    if (record.deviceType === 'Mobile') {
                        courseSummary[key].mobileCount++;
                    } else if (record.deviceType === 'Desktop') {
                        courseSummary[key].desktopCount++;
                    }
                });
                
                for (const [key, data] of Object.entries(courseSummary)) {
                    report += `  ${data.course} - ${data.date}:\n`;
                    report += `    Total: ${data.total} attendance(s)\n`;
                    report += `    Unique Students: ${data.students.size}\n`;
                    report += `    Mobile Submissions: ${data.mobileCount}\n`;
                    report += `    Desktop Submissions: ${data.desktopCount}\n`;
                }
                
                alert(report);
                showFlashMessage('Report generated (text format) successfully!', 'success');
            }
        }
        
        function exportData() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            
            if (records.length === 0) {
                showFlashMessage('No records to export', 'error');
                return;
            }
            
            let csv = 'Student Name,Matric Number,Course Code,Date,Time,Latitude,Longitude,Device Name,Device Type,Cloud Synced,Submitted From\n';
            records.forEach(record => {
                csv += `"${record.studentName}","${record.matricNumber}","${record.courseCode}","${record.date}","${record.time}",${record.latitude},${record.longitude},"${record.deviceName || ''}","${record.deviceType || ''}","${record.synced ? 'Yes' : 'No'}","${record.submittedFrom || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_records_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showFlashMessage('CSV exported successfully!', 'success');
        }
        
        // Admin Dashboard Functions
        async function loadAdminDashboard() {
            console.log('Loading admin dashboard...');
            if (!currentUser || currentUser.role !== 'admin') {
                showFlashMessage('Access denied. Please login as administrator.', 'error');
                showView('home');
                return;
            }
            
            // Sync from cloud to get latest user data
            if (navigator.onLine) {
                await syncFromCloud();
            }
            
            document.getElementById('adminName').textContent = `Welcome, ${currentUser.fullName}!`;
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const pendingLecturers = users.filter(u => u.role === 'lecturer' && !u.isApproved);
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(r => r.date === today);
            
            document.getElementById('totalAdmins').textContent = users.filter(u => u.role === 'admin').length;
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeSessionsAdmin').textContent = Object.keys(activeSessions).length.toString();
            document.getElementById('attendanceToday').textContent = todayRecords.length;
            document.getElementById('pendingApprovals').textContent = pendingLecturers.length;
            
            loadLecturerApprovals(pendingLecturers);
        }
        
        function loadLecturerApprovals(pendingLecturers) {
            const lecturerApprovalsList = document.getElementById('lecturerApprovalsList');
            
            if (pendingLecturers.length > 0) {
                lecturerApprovalsList.innerHTML = pendingLecturers.map(lecturer => `
                    <div class="border border-yellow-200 dark:border-yellow-900 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-slate-900 dark:text-white">${lecturer.fullName}</h3>
                            <span class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 text-xs px-2 py-1 rounded-full">Pending</span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Username: <strong>${lecturer.username}</strong></p>
                        <p class="text-xs text-slate-500 dark:text-slate-500 mb-3">
                            Registered: ${new Date(lecturer.createdAt || Date.now()).toLocaleString()}
                        </p>
                        <div class="flex space-x-2">
                            <button onclick="approveLecturer('${lecturer.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold text-sm transition-colors">Approve</button>
                            <button onclick="rejectLecturer('${lecturer.id}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-semibold text-sm transition-colors">Reject</button>
                        </div>
                    </div>
                `).join('');
            } else {
                lecturerApprovalsList.innerHTML = `
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-500 mb-3">check_circle</span>
                        <p class="text-slate-500 dark:text-slate-400">No pending lecturer approvals</p>
                        <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">All lecturers are approved</p>
                    </div>
                `;
            }
        }
        
        async function approveLecturer(userId) {
            if (!confirm('Are you sure you want to approve this lecturer?')) {
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id == userId);
            
            if (userIndex !== -1) {
                users[userIndex].isApproved = true;
                users[userIndex].updatedAt = new Date().toISOString();
                localStorage.setItem('users', JSON.stringify(users));
                
                // Sync to cloud after approval
                await syncToCloud();
                
                showFlashMessage('Lecturer approved successfully!', 'success');
                
                setTimeout(() => {
                    loadAdminDashboard();
                }, 1500);
            } else {
                showFlashMessage('Lecturer not found', 'error');
            }
        }
        
        async function rejectLecturer(userId) {
            if (!confirm('Are you sure you want to reject this lecturer registration?')) {
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const updatedUsers = users.filter(u => u.id != userId);
            localStorage.setItem('users', JSON.stringify(updatedUsers));
            
            // Sync to cloud after rejection
            await syncToCloud();
            
            showFlashMessage('Lecturer registration rejected successfully!', 'success');
            
            setTimeout(() => {
                loadAdminDashboard();
            }, 1500);
        }
        
        function viewAllUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (users.length === 0) {
                showFlashMessage('No users found', 'info');
                return;
            }
            
            let message = 'ALL USERS REPORT\n\n';
            users.forEach((user, index) => {
                message += `${index + 1}. ${user.fullName}\n`;
                message += `   Username: ${user.username}\n`;
                message += `   Role: ${user.role}\n`;
                message += `   Status: ${user.isApproved ? 'Approved' : 'Pending'}\n`;
                if (user.matricNumber) message += `   Matric: ${user.matricNumber}\n`;
                if (user.lastDevice) message += `   Last Device: ${user.lastDevice.name}\n`;
                message += `   Created: ${new Date(user.createdAt || Date.now()).toLocaleString()}\n`;
                message += 'â”€'.repeat(40) + '\n';
            });
            
            alert(message);
        }
        
        function viewAllAttendance() {
            const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            
            if (records.length === 0) {
                showFlashMessage('No attendance records found', 'info');
                return;
            }
            
            let message = 'ALL ATTENDANCE RECORDS\n\n';
            records.forEach((record, index) => {
                message += `${index + 1}. ${record.studentName}\n`;
                message += `   Matric: ${record.matricNumber}\n`;
                message += `   Course: ${record.courseCode}\n`;
                message += `   Date: ${record.date} ${record.time}\n`;
                message += `   Device: ${record.deviceName || record.deviceType || 'Unknown'}\n`;
                message += `   Location: ${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}\n`;
                message += `   Cloud Sync: ${record.synced ? 'Yes' : 'Pending'}\n`;
                message += 'â”€'.repeat(40) + '\n';
            });
            
            alert(message);
        }
        
        function manageCourses() {
            showFlashMessage('Course management feature would be implemented here', 'info');
        }
        
        // Utility functions
        function showFlashMessage(message, type = 'info') {
            const flashMessages = document.getElementById('flashMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `rounded-xl p-4 mb-3 fade-in flex items-center ${
                type === 'success' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-900 text-green-800 dark:text-green-300' :
                type === 'error' ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900 text-red-800 dark:text-red-300' :
                type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-900 text-yellow-800 dark:text-yellow-300' :
                'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-900 text-blue-800 dark:text-blue-300'
            }`;
            
            // Add appropriate icon
            const iconSpan = document.createElement('span');
            iconSpan.className = 'material-symbols-outlined mr-2';
            if (type === 'success') iconSpan.textContent = 'check_circle';
            else if (type === 'error') iconSpan.textContent = 'error';
            else if (type === 'warning') iconSpan.textContent = 'warning';
            else iconSpan.textContent = 'info';
            
            messageDiv.appendChild(iconSpan);
            messageDiv.appendChild(document.createTextNode(message));
            
            flashMessages.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 500);
                }
            }, 5000);
        }
        
        // Signup functions
        function selectRole(role) {
            document.getElementById('selectedRole').value = role;
            
            ['student', 'lecturer', 'admin'].forEach(r => {
                const btn = document.getElementById('role' + r.charAt(0).toUpperCase() + r.slice(1));
                if (r === role) {
                    btn.classList.add('border-primary', 'bg-primary/10');
                    btn.classList.remove('border-slate-200', 'dark:border-slate-700');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary/10');
                    btn.classList.add('border-slate-200', 'dark:border-slate-700');
                }
            });
            
            const matricField = document.getElementById('matricField');
            if (role === 'student') {
                matricField.style.display = 'block';
            } else {
                matricField.style.display = 'none';
            }
        }
        
        function togglePassword(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'visibility';
            } else {
                input.type = 'password';
                toggle.textContent = 'visibility_off';
            }
        }
        
        function checkPasswordStrength(password) {
            const strength = {
                length: password.length >= 8,
                hasUpper: /[A-Z]/.test(password),
                hasLower: /[a-z]/.test(password),
                hasNumber: /\d/.test(password),
                hasSpecial: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            const score = Object.values(strength).filter(Boolean).length;
            const strengthDiv = document.getElementById('passwordStrength');
            const bars = [1, 2, 3, 4].map(i => document.getElementById('strength' + i));
            
            bars.forEach((bar, index) => {
                if (index < score) {
                    if (score >= 4) bar.className = 'h-1 rounded bg-green-500';
                    else if (score >= 3) bar.className = 'h-1 rounded bg-blue-500';
                    else if (score >= 2) bar.className = 'h-1 rounded bg-yellow-500';
                    else bar.className = 'h-1 rounded bg-red-500';
                } else {
                    bar.className = 'h-1 rounded bg-slate-200 dark:bg-slate-700';
                }
            });
            
            let message = '';
            let color = '';
            
            if (score >= 4) {
                message = 'Strong password';
                color = 'text-green-600 dark:text-green-400';
            } else if (score >= 3) {
                message = 'Good password';
                color = 'text-blue-600 dark:text-blue-400';
            } else if (score >= 2) {
                message = 'Fair password';
                color = 'text-yellow-600 dark:text-yellow-400';
            } else if (password.length > 0) {
                message = 'Weak password';
                color = 'text-red-600 dark:text-red-400';
            }
            
            strengthDiv.innerHTML = message ? `<span class="${color} font-medium">${message}</span>` : '';
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirm.length === 0) {
                matchDiv.innerHTML = '';
                return;
            }
            
            if (password === confirm) {
                matchDiv.innerHTML = '<span class="text-green-600 dark:text-green-400 font-medium">âœ“ Passwords match</span>';
            } else {
                matchDiv.innerHTML = '<span class="text-red-600 dark:text-red-400 font-medium">âœ— Passwords do not match</span>';
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            initializeTheme();
            
            // Generate a session ID for this device even if not logged in
            sessionId = generateSessionId();
            
            // Initialize sync - but don't wait for it
            setTimeout(async () => {
                if (navigator.onLine) {
                    await syncFromCloud();
                }
            }, 1000);
            
            // Check for existing user session
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('Found saved user:', currentUser.role);
                    
                    // Restore session
                    if (currentUser.sessionId) {
                        sessionId = currentUser.sessionId;
                    }
                    
                    // Load active sessions
                    activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                    
                    // Check if this session is still valid (not logged out from another device)
                    if (!activeSessions[sessionId] && currentUser) {
                        console.log('Session was terminated from another device');
                        showFlashMessage('You have been logged out from another device', 'warning');
                        logout();
                    } else {
                        // Update session last active
                        activeSessions[sessionId].lastActive = Date.now();
                        localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                        
                        updateNavigation();
                        updateDeviceCount();
                        
                        // Redirect to appropriate dashboard based on user role
                        setTimeout(() => {
                            switch(currentUser.role) {
                                case 'student':
                                    showView('studentDashboard');
                                    break;
                                case 'lecturer':
                                    showView('lecturerDashboard');
                                    break;
                                case 'admin':
                                    showView('adminDashboard');
                                    break;
                                default:
                                    console.log('Unknown role, showing home');
                                    showView('home');
                            }
                        }, 100);
                        
                        // Start periodic session updates
                        setInterval(async () => {
                            if (currentUser) {
                                await syncSessionState();
                            }
                        }, 30000); // Update every 30 seconds
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    showView('splash');
                }
            } else {
                console.log('No saved user, showing splash');
                showView('splash');
            }
            
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('loginUsername').value;
                    const password = document.getElementById('loginPassword').value;
                    login(username, password);
                });
            }
            
            // Signup form
            const signupForm = document.getElementById('signupForm');
            if (signupForm) {
                signupForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const role = document.getElementById('selectedRole').value;
                    const fullName = document.getElementById('fullName').value;
                    const username = document.getElementById('signupUsername').value;
                    const password = document.getElementById('signupPassword').value;
                    const matricNumber = document.getElementById('matricNumber').value;
                    
                    if (role === 'student' && !matricNumber) {
                        showFlashMessage('Matric number is required for students', 'error');
                        return;
                    }
                    
                    if (password !== document.getElementById('confirmPassword').value) {
                        showFlashMessage('Passwords do not match', 'error');
                        return;
                    }
                    
                    const userData = {
                        id: Date.now(),
                        username: username,
                        password: password,
                        role: role,
                        fullName: fullName,
                        matricNumber: role === 'student' ? matricNumber : null,
                        isApproved: role !== 'lecturer',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    signup(userData);
                });
            }
            
            // Password reset form
            const resetForm = document.getElementById('resetForm');
            if (resetForm) {
                resetForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('resetUsername').value;
                    resetPassword(username);
                });
            }
            
            // Student dashboard buttons
            const captureLocationBtn = document.getElementById('captureLocation');
            if (captureLocationBtn) {
                captureLocationBtn.addEventListener('click', captureLocation);
            }
            
            const startCameraBtn = document.getElementById('startCamera');
            if (startCameraBtn) {
                startCameraBtn.addEventListener('click', startCamera);
            }
            
            const captureFaceBtn = document.getElementById('captureFace');
            if (captureFaceBtn) {
                captureFaceBtn.addEventListener('click', captureFace);
            }
            
            const retakePhotoBtn = document.getElementById('retakePhoto');
            if (retakePhotoBtn) {
                retakePhotoBtn.addEventListener('click', retakePhoto);
            }
            
            const attendanceForm = document.getElementById('attendanceForm');
            if (attendanceForm) {
                attendanceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitAttendance();
                });
            }
            
            const courseCodeSelect = document.getElementById('courseCode');
            if (courseCodeSelect) {
                courseCodeSelect.addEventListener('change', updateSubmitButton);
            }
            
            // Auto-refresh checkbox
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (autoRefreshCheckbox) {
                autoRefreshCheckbox.addEventListener('change', startAutoRefresh);
            }
            
            // Online/offline detection
            window.addEventListener('online', async () => {
                showFlashMessage('You are back online. Syncing data...', 'success');
                await syncData();
                if (currentUser) {
                    await syncSessionState();
                }
            });
            
            window.addEventListener('offline', () => {
                showFlashMessage('You are offline. Working with local data.', 'warning');
            });
            
            // Before unload, update session state
            window.addEventListener('beforeunload', () => {
                if (currentUser && sessionId && activeSessions[sessionId]) {
                    // Mark session as inactive (will be cleaned up on next sync)
                    delete activeSessions[sessionId];
                    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                    
                    // Try to sync one last time (synchronous XHR)
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', REMOTE_STORAGE_URL + '/sessions', false); // synchronous
                        xhr.setRequestHeader('Content-Type', 'application/json');
                        xhr.setRequestHeader('X-Master-Key', API_KEY);
                        xhr.send(JSON.stringify({ sessions: activeSessions }));
                    } catch (e) {
                        console.log('Could not sync on unload');
                    }
                }
            });
            
            console.log('Event listeners initialized');
        });
    </script>
</body>
</html>